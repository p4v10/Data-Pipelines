service: rss
frameworkVersion: '3'

provider:
  name: aws
  runtime: python3.11
  region: us-east-1
  stage: dev

custom:
  stage: ${opt:stage, self:provider.stage}
  product: ai

# Lambda
functions:

  # Function that gets initial RSS feed data
  get-feed-and-article:
    handler: Lambdas/feed-parser-lambda-package/lambda-get-feed.lambda_handler
    name: ${self:service}-${self:custom.product}-${self:custom.stage}-get-feed-articles
    description: Lambda to pull RSS data
    # Specify the path to your Lambda function code
    package:
      include:
        - Lambdas/feed-parser-lambda-package/
        - requirements.txt
    environment:  # Add any environment variables here if needed
      VARIABLE_NAME: variable_value
    timeout: 60

  # This function scrapes the article body from the RSS feed link
  scrape-article-body:
    handler: Lambdas/scrape-articles-body-package/lambda-scrape-article.lambda_handler
    name: ${self:service}-${self:custom.product}-${self:custom.stage}-scrape-articles-body
    description: Lambda that scrapes Articles body from the news website using RSS Feed Link
    # Specify the path to your Lambda function code
    package:
      include:
        - Lambdas/scrape-articles-body-package/
        - requirements.txt
    environment:  # Add any environment variables here if needed
      VARIABLE_NAME: variable_value
    timeout: 60

resources:
  Resources:
    RssFeedSourceTable:
      Type: 'AWS::DynamoDB::Table'
      Properties:
        BillingMode: PAY_PER_REQUEST
        TableName: ${self:service}-${self:custom.product}-${self:custom.stage}-source
        AttributeDefinitions:
          - AttributeName: feed_article_id
            AttributeType: N
          - AttributeName: feed_article_published_date
            AttributeType: S
          - AttributeName: feed_article_title
            AttributeType: S
          - AttributeName: feed_article_summary
            AttributeType: S
          - AttributeName: feed_article_link
            AttributeType: S
          - AttributeName: feed_article_author
            AttributeType: S
          - AttributeName: rss_feed_title
            AttributeType: S
          - AttributeName: rss_feed_link
            AttributeType: S
        KeySchema:
          - AttributeName: feed_article_id
            KeyType: HASH
          - AttributeName: feed_article_published_date
            KeyType: RANGE
        GlobalSecondaryIndexes:
        - IndexName: FeedArticleTitleIndex
          KeySchema:
          - AttributeName: feed_article_title
            KeyType: HASH
          - AttributeName: feed_article_published_date
            KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: ArticleSummaryIndex
          KeySchema:
          - AttributeName: feed_article_summary
            KeyType: HASH
          - AttributeName: feed_article_published_date
            KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: ArticleLinkIndex
          KeySchema:
          - AttributeName: feed_article_link
            KeyType: HASH
          - AttributeName: feed_article_published_date
            KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: ArticleAuthorIndex
          KeySchema:
          - AttributeName: feed_article_author
            KeyType: HASH
          - AttributeName: feed_article_published_date
            KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: RSSFeedTitleIndex
          KeySchema:
          - AttributeName: rss_feed_title
            KeyType: HASH
          - AttributeName: feed_article_published_date
            KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: RSSFeedLinkIndex
          KeySchema:
          - AttributeName: rss_feed_link
            KeyType: HASH
          - AttributeName: feed_article_published_date
            KeyType: RANGE
          Projection:
            ProjectionType: ALL

plugins:
  - serverless-python-requirements  # Plugin to bundle Python dependencies